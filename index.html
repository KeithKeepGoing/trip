<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2026 æ±äº¬å®¶åº­æ—…è¡Œ ğŸ’</title>
  <meta name="description" content="2026å¹´æ±äº¬å®¶åº­æ—…è¡Œè¡Œç¨‹è¦åŠƒ - ç¤¦çŸ³é¢¨æ ¼äº’å‹•å¼æ—…éŠæŒ‡å—">
  <meta name="theme-color" content="#0c0a1d">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --crystal-purple: #a855f7;
      --crystal-blue: #3b82f6;
      --crystal-teal: #14b8a6;
      --crystal-pink: #ec4899;
      --crystal-amber: #f59e0b;
      --bg-dark: #0c0a1d;
      --bg-card: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.08);
    }
    
    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-dark);
      background-image: 
        radial-gradient(ellipse at 20% 20%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(59, 130, 246, 0.12) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(20, 184, 166, 0.08) 0%, transparent 60%);
      min-height: 100vh;
    }
    
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    
    .crystal-bg {
      background: linear-gradient(135deg, 
        rgba(168, 85, 247, 0.2) 0%, 
        rgba(59, 130, 246, 0.15) 50%, 
        rgba(20, 184, 166, 0.2) 100%);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.04);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 
        0 4px 30px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }
    
    .gem-glow {
      box-shadow: 
        0 0 20px rgba(168, 85, 247, 0.3),
        0 0 40px rgba(59, 130, 246, 0.2),
        0 0 60px rgba(20, 184, 166, 0.1);
    }
    
    .gem-text {
      background: linear-gradient(135deg, #a855f7 0%, #3b82f6 50%, #14b8a6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .crystal-border {
      position: relative;
    }
    .crystal-border::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg, 
        rgba(168, 85, 247, 0.5), 
        rgba(59, 130, 246, 0.3), 
        rgba(20, 184, 166, 0.5));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }
    
    .shimmer {
      background: linear-gradient(
        110deg,
        transparent 20%,
        rgba(255, 255, 255, 0.1) 50%,
        transparent 80%
      );
      background-size: 200% 100%;
      animation: shimmer 3s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes pulse-glow {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
    
    @keyframes countdown-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .float-anim {
      animation: float 6s ease-in-out infinite;
    }
    
    .pulse-glow {
      animation: pulse-glow 3s ease-in-out infinite;
    }
    
    .countdown-pulse {
      animation: countdown-pulse 2s ease-in-out infinite;
    }
    
    .facet-pattern {
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L60 30L30 60L0 30Z' fill='none' stroke='rgba(168,85,247,0.05)' stroke-width='1'/%3E%3C/svg%3E");
    }
    
    .nav-btn {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .nav-btn:hover {
      transform: translateY(-2px);
    }
    .nav-btn.active {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(59, 130, 246, 0.2));
      border-color: rgba(168, 85, 247, 0.5);
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.3);
    }
    
    .timeline-line {
      background: linear-gradient(180deg, 
        rgba(168, 85, 247, 0.5) 0%, 
        rgba(59, 130, 246, 0.3) 50%, 
        rgba(20, 184, 166, 0.5) 100%);
    }
    
    .timeline-dot {
      background: linear-gradient(135deg, #a855f7, #3b82f6);
      box-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
    }
    
    .checklist-item {
      transition: all 0.3s ease;
    }
    .checklist-item.checked {
      opacity: 0.5;
      text-decoration: line-through;
    }
    
    #map-container {
      height: 300px;
      border-radius: 1rem;
      overflow: hidden;
    }
    
    .leaflet-container {
      background: #1a1a2e;
    }
    
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }
    
    .photo-item {
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="facet-pattern min-h-screen text-white pb-20">
  <div id="app" class="max-w-md mx-auto min-h-screen relative overflow-hidden">
    
    <!-- Loading -->
    <div v-if="loading" class="flex flex-col items-center justify-center h-screen space-y-6">
      <div class="text-6xl float-anim">ğŸ’</div>
      <div class="gem-text font-bold tracking-[0.3em] text-sm">LOADING...</div>
      <div class="w-32 h-1 rounded-full overflow-hidden bg-white/10">
        <div class="h-full crystal-bg shimmer"></div>
      </div>
    </div>

    <div v-else class="pb-24">
      <!-- Hero -->
      <header class="relative pt-10 pb-20 px-6 overflow-hidden">
        <!-- Decorative crystals -->
        <div class="absolute top-10 right-10 w-20 h-20 opacity-20 float-anim" style="animation-delay: -2s;">
          <svg viewBox="0 0 100 100" fill="none">
            <polygon points="50,0 100,50 50,100 0,50" stroke="url(#grad1)" stroke-width="2"/>
            <defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#a855f7"/>
              <stop offset="100%" style="stop-color:#3b82f6"/>
            </linearGradient></defs>
          </svg>
        </div>
        <div class="absolute bottom-20 left-5 w-12 h-12 opacity-15 float-anim" style="animation-delay: -4s;">
          <svg viewBox="0 0 100 100" fill="none">
            <polygon points="50,0 100,50 50,100 0,50" stroke="#14b8a6" stroke-width="2"/>
          </svg>
        </div>
        
        <div class="relative z-10 text-center">
          <div class="inline-flex items-center gap-2 bg-white/5 backdrop-blur border border-white/10 rounded-full px-4 py-1.5 mb-4">
            <span class="w-2 h-2 rounded-full bg-green-400 pulse-glow"></span>
            <span class="text-xs font-medium text-white/70 tracking-wider uppercase">Tokyo Trip 2026</span>
          </div>
          
          <h1 class="text-4xl font-black tracking-tight leading-tight mb-3">
            <span class="gem-text">{{ config.tripMeta.title }}</span>
          </h1>
          <p class="text-white/50 text-sm font-medium">{{ config.tripMeta.subtitle }}</p>
          
          <!-- Countdown -->
          <div class="mt-6 glass-card crystal-border rounded-2xl p-4 countdown-pulse">
            <div class="text-xs text-purple-400 font-bold mb-1">{{ countdownLabel }}</div>
            <div class="text-3xl font-black gem-text">{{ countdownDays }}</div>
            <div class="text-xs text-white/40">{{ countdownSubtext }}</div>
          </div>
          
          <div class="mt-6 flex justify-center gap-3">
            <div class="glass-card px-4 py-2 rounded-xl text-xs font-semibold flex items-center gap-2">
              <span class="text-purple-400">ğŸ“…</span>
              <span class="text-white/80">{{ shortDate(config.tripMeta.startDate) }} - {{ shortDate(config.tripMeta.endDate) }}</span>
            </div>
            <div class="glass-card px-4 py-2 rounded-xl text-xs font-semibold flex items-center gap-2">
              <span class="text-blue-400">ğŸ“</span>
              <span class="text-white/80">{{ config.tripMeta.baseCity }}</span>
            </div>
          </div>
        </div>
        
        <!-- Bottom glow -->
        <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-3/4 h-px bg-gradient-to-r from-transparent via-purple-500/50 to-transparent"></div>
      </header>

      <!-- Floating Nav -->
      <div class="sticky top-0 z-30 px-4 -mt-8 mb-6">
        <div class="glass-card rounded-2xl p-2">
          <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide snap-x">
            <button 
              @click="activeKind = 'overview'"
              class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-semibold border border-white/10 bg-white/5"
              :class="activeKind === 'overview' ? 'active' : 'text-white/60 hover:text-white hover:bg-white/10'"
            >âœ¨ ç¸½è¦½</button>
            <button 
              v-for="day in config.days" 
              :key="day.date"
              @click="selectDay(day.date)"
              class="nav-btn snap-start flex-shrink-0 px-3 py-2 rounded-xl border border-white/10 bg-white/5 flex flex-col items-center justify-center min-w-[60px]"
              :class="activeKind === 'day' && activeDayDate === day.date ? 'active' : 'text-white/60 hover:text-white hover:bg-white/10'"
            >
              <span class="text-[10px] font-bold">{{ day.label }}</span>
              <span class="text-[9px] opacity-50">{{ shortDate(day.date) }}</span>
            </button>
            <button @click="activeKind = 'map'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-semibold border border-white/10 bg-white/5" :class="activeKind === 'map' ? 'active' : 'text-white/60'">ğŸ—ºï¸ åœ°åœ–</button>
            <button @click="activeKind = 'packing'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-semibold border border-white/10 bg-white/5" :class="activeKind === 'packing' ? 'active' : 'text-white/60'">ğŸ“¦ æ‰“åŒ…</button>
            <button @click="activeKind = 'budget'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-semibold border border-white/10 bg-white/5" :class="activeKind === 'budget' ? 'active' : 'text-white/60'">ğŸ’° è¨˜å¸³</button>
            <button @click="activeKind = 'currency'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-semibold border border-white/10 bg-white/5" :class="activeKind === 'currency' ? 'active' : 'text-white/60'">ğŸ’± åŒ¯ç‡</button>
            <button @click="activeKind = 'phrase'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-semibold border border-white/10 bg-white/5" :class="activeKind === 'phrase' ? 'active' : 'text-white/60'">ğŸ—£ï¸ æ—¥èª</button>
            <button @click="activeKind = 'photos'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-semibold border border-white/10 bg-white/5" :class="activeKind === 'photos' ? 'active' : 'text-white/60'">ğŸ“¸ ç…§ç‰‡</button>
            <button @click="activeKind = 'weather'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-semibold border border-white/10 bg-white/5" :class="activeKind === 'weather' ? 'active' : 'text-white/60'">â˜ï¸ å¤©æ°£</button>
            <button @click="activeKind = 'emergency'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-semibold border border-white/10 bg-white/5" :class="activeKind === 'emergency' ? 'active' : 'text-white/60'">ğŸ†˜ ç·Šæ€¥</button>
            <button @click="activeKind = 'share'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-semibold border border-white/10 bg-white/5" :class="activeKind === 'share' ? 'active' : 'text-white/60'">ğŸ”— åˆ†äº«</button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <main class="px-5 space-y-6">

        <!-- Overview -->
        <div v-if="activeKind === 'overview'" class="space-y-6">
          <!-- Flight Card -->
          <section>
            <h3 class="text-xs font-bold text-purple-400/80 uppercase tracking-widest mb-3 pl-1 flex items-center gap-2">
              <span class="w-4 h-px bg-purple-500/50"></span>
              Flights
            </h3>
            <div v-for="f in config.flights" :key="f.id" class="mb-3 glass-card crystal-border rounded-2xl p-5 relative overflow-hidden">
              <div class="absolute top-0 right-0 w-full h-full shimmer pointer-events-none"></div>
              <div class="absolute -top-5 -right-5 text-7xl opacity-5">âœˆï¸</div>
              <div class="flex justify-between items-center mb-4 relative z-10">
                <span class="bg-purple-500/20 text-purple-300 text-[10px] font-bold px-2.5 py-1 rounded-lg border border-purple-500/30">{{ f.airline }}</span>
                <span class="text-xs font-bold text-white/40">{{ dateOnly(f.departure) }}</span>
              </div>
              <div class="flex justify-between items-center relative z-10">
                <div>
                  <div class="text-3xl font-black gem-text">{{ f.from.code }}</div>
                  <div class="text-xs font-bold text-white/50">{{ timeOnly(f.departure) }}</div>
                </div>
                <div class="flex flex-col items-center px-4 w-full">
                  <div class="text-[10px] text-white/40 font-bold mb-2">{{ f.flightNo }}</div>
                  <div class="w-full h-0.5 bg-gradient-to-r from-purple-500/50 via-blue-500/50 to-teal-500/50 relative rounded-full">
                    <div class="absolute -right-1 top-1/2 -translate-y-1/2 w-2 h-2 bg-teal-400 rounded-full shadow-lg shadow-teal-500/50"></div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-3xl font-black gem-text">{{ f.to.code }}</div>
                  <div class="text-xs font-bold text-white/50">{{ timeOnly(f.arrival) }}</div>
                </div>
              </div>
            </div>
          </section>

          <!-- Stays Card -->
          <section>
            <h3 class="text-xs font-bold text-blue-400/80 uppercase tracking-widest mb-3 pl-1 flex items-center gap-2">
              <span class="w-4 h-px bg-blue-500/50"></span>
              Accommodation
            </h3>
            <div class="space-y-3">
              <div v-for="s in config.stays" :key="s.id" class="glass-card rounded-2xl p-4 flex gap-4 items-center group hover:bg-white/[0.08] transition-all duration-300 cursor-pointer">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500/30 to-blue-500/30 flex items-center justify-center text-xl border border-white/10 group-hover:scale-110 transition-transform">
                  ğŸ¨
                </div>
                <div class="flex-1">
                  <h4 class="font-bold text-white text-sm">{{ s.name }}</h4>
                  <div class="text-xs text-white/40 mt-0.5">{{ s.area }} Â· {{ shortDate(s.checkIn) }}-{{ shortDate(s.checkOut) }}</div>
                </div>
                <div class="text-white/20 group-hover:text-purple-400 transition-colors">â†’</div>
              </div>
            </div>
          </section>
        </div>

        <!-- Day Detail -->
        <div v-else-if="activeKind === 'day'" class="space-y-6">
          <div v-if="currentDay">
            <!-- Day Header -->
            <div class="glass-card crystal-border rounded-3xl p-6 text-center relative overflow-hidden gem-glow">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 via-blue-500 to-teal-500"></div>
              <div class="absolute inset-0 shimmer pointer-events-none"></div>
              
              <div class="relative z-10">
                <div class="text-xs font-bold text-purple-400 mb-2">{{ currentDay.date }} Â· {{ currentDay.label }}</div>
                <h2 class="text-2xl font-black mb-3 leading-tight gem-text">{{ currentDay.title }}</h2>
                <div v-if="currentDay.weather" class="inline-flex items-center gap-1.5 bg-blue-500/20 text-blue-300 px-3 py-1.5 rounded-full text-xs font-bold mb-4 border border-blue-500/30">
                  <span>{{ currentDay.weather }}</span>
                </div>
                
                <!-- Stay Badge -->
                <div v-if="currentDay.stayId" class="flex items-center justify-center gap-2 text-xs text-white/60 bg-white/5 rounded-xl p-3 mt-2 border border-white/10">
                  <span>ğŸ </span>
                  <span class="font-bold">{{ stayName(currentDay.stayId) }}</span>
                </div>
              </div>
            </div>

            <!-- Blocks -->
            <div class="space-y-4">
              <div v-for="(block, idx) in currentDay.blocks" :key="idx" class="relative pl-8">
                <!-- Timeline Line -->
                <div class="absolute left-[11px] top-8 bottom-0 w-0.5 timeline-line -z-10" v-if="idx !== currentDay.blocks.length - 1"></div>
                
                <!-- Icon -->
                <div class="absolute left-0 top-1 w-6 h-6 rounded-full timeline-dot flex items-center justify-center text-xs z-10">
                  {{ getBlockIcon(block.type) }}
                </div>

                <!-- Content Card -->
                <div :class="['glass-card rounded-2xl p-4 ml-2 transition-all hover:bg-white/[0.08]', block.type === 'dinnerRecommend' ? 'border-l-2 border-l-amber-500/50' : '']">
                  
                  <!-- Header -->
                  <div class="flex justify-between items-start mb-3">
                    <h3 class="font-bold text-white text-sm">{{ block.title }}</h3>
                    <span v-if="block.timeOfDay" class="text-[10px] font-bold bg-white/10 text-white/60 px-2 py-0.5 rounded-full">{{ block.timeOfDay }}</span>
                  </div>

                  <!-- Transport -->
                  <div v-if="block.type === 'transport'" class="space-y-3">
                    <div class="flex items-center gap-2 text-xs font-bold text-white/60">
                      <span>{{ block.from }}</span>
                      <span class="text-purple-400">â†’</span>
                      <span>{{ block.to }}</span>
                    </div>
                    <div v-for="route in block.routes" class="bg-white/5 rounded-xl p-3 border border-white/5">
                      <div class="font-bold text-white/90 text-sm mb-1">{{ route.label }}</div>
                      <div class="text-[10px] text-white/40 mb-2 flex gap-3">
                        <span v-if="route.estimatedDurationMinutes" class="flex items-center gap-1"><span class="text-blue-400">â±</span> {{ route.estimatedDurationMinutes }}åˆ†</span>
                        <span v-if="route.estimatedCost" class="flex items-center gap-1"><span class="text-teal-400">ğŸ’°</span> {{ route.estimatedCost }}</span>
                      </div>
                      <div v-if="route.via" class="space-y-1.5">
                        <div v-for="step in route.via" class="text-xs text-white/60 flex items-start gap-2">
                          <span class="text-purple-400 mt-0.5">â—†</span>
                          <span class="leading-relaxed">{{ step }}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Dinner Recommend -->
                  <div v-else-if="block.type === 'dinnerRecommend'" class="space-y-3">
                    <div v-for="opt in block.options" class="bg-gradient-to-r from-amber-500/10 to-orange-500/5 rounded-xl p-3 border border-amber-500/20">
                      <div class="flex justify-between items-start">
                        <div class="font-bold text-white text-sm">{{ opt.name }}</div>
                        <div class="text-xs font-bold text-amber-400 bg-amber-500/20 px-2 py-0.5 rounded-lg">{{ opt.rating }}</div>
                      </div>
                      <div class="flex flex-wrap gap-1.5 my-2">
                        <span v-for="tag in opt.tags" class="text-[10px] bg-white/10 text-white/60 px-2 py-0.5 rounded-full">{{ tag }}</span>
                      </div>
                      <div class="text-xs text-white/50 leading-relaxed">{{ opt.desc }}</div>
                      <a v-if="opt.url" :href="opt.url" target="_blank" class="mt-3 block text-center bg-amber-500/20 text-amber-300 text-xs font-bold py-2 rounded-lg hover:bg-amber-500/30 transition-colors border border-amber-500/30">ğŸ“ Google Maps</a>
                    </div>
                  </div>

                  <!-- List Items -->
                  <ul v-else-if="block.items" class="space-y-2">
                    <li v-for="item in block.items" class="text-sm text-white/70 flex items-start gap-2">
                      <span class="text-teal-400 font-bold mt-0.5">âœ“</span>
                      <span class="leading-relaxed">{{ item }}</span>
                    </li>
                  </ul>

                  <!-- Note/Lines -->
                  <div v-else-if="block.lines" class="text-sm text-white/60 space-y-1">
                    <p v-for="line in block.lines">{{ line }}</p>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Map -->
        <div v-else-if="activeKind === 'map'" class="space-y-4">
          <div class="glass-card crystal-border rounded-2xl p-4">
            <h3 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
              <span class="text-purple-400">ğŸ—ºï¸</span> æ™¯é»åœ°åœ–
            </h3>
            <div id="map-container" class="glass-card"></div>
            <div class="mt-3 text-xs text-white/40 text-center">é»æ“Šæ¨™è¨˜æŸ¥çœ‹è©³æƒ…</div>
          </div>
          
          <div class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-white mb-3">åœ–ä¾‹</h3>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div class="flex items-center gap-2 text-white/60"><span class="w-3 h-3 rounded-full bg-purple-500"></span> æ™¯é»</div>
              <div class="flex items-center gap-2 text-white/60"><span class="w-3 h-3 rounded-full bg-blue-500"></span> ä½å®¿</div>
              <div class="flex items-center gap-2 text-white/60"><span class="w-3 h-3 rounded-full bg-amber-500"></span> é¤å»³</div>
              <div class="flex items-center gap-2 text-white/60"><span class="w-3 h-3 rounded-full bg-teal-500"></span> è³¼ç‰©</div>
            </div>
          </div>
        </div>

        <!-- Packing List -->
        <div v-else-if="activeKind === 'packing'" class="space-y-4">
          <div class="glass-card crystal-border rounded-2xl p-4 text-center">
            <div class="text-3xl font-black gem-text">{{ packingProgress }}%</div>
            <div class="text-xs text-white/50 mt-1">æ‰“åŒ…é€²åº¦</div>
            <div class="w-full h-2 bg-white/10 rounded-full mt-3 overflow-hidden">
              <div class="h-full bg-gradient-to-r from-purple-500 to-teal-500 transition-all duration-500" :style="{width: packingProgress + '%'}"></div>
            </div>
          </div>
          
          <div v-for="cat in packingCategories" :key="cat.name" class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
              <span>{{ cat.icon }}</span> {{ cat.name }}
            </h3>
            <div class="space-y-2">
              <div v-for="item in cat.items" :key="item" 
                   @click="togglePackingItem(cat.name, item)"
                   class="checklist-item flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-pointer transition-all"
                   :class="{ 'checked': isPackedItem(cat.name, item) }">
                <div class="w-5 h-5 rounded border-2 flex items-center justify-center transition-all"
                     :class="isPackedItem(cat.name, item) ? 'bg-teal-500 border-teal-500' : 'border-white/30'">
                  <span v-if="isPackedItem(cat.name, item)" class="text-xs">âœ“</span>
                </div>
                <span class="text-sm text-white/80">{{ item }}</span>
              </div>
            </div>
          </div>
          
          <button @click="resetPacking" class="w-full py-3 text-xs font-bold text-white/30 hover:text-red-400 transition-colors">
            ğŸ”„ é‡ç½®æ‰“åŒ…æ¸…å–®
          </button>
        </div>

        <!-- Currency Converter -->
        <div v-else-if="activeKind === 'currency'" class="space-y-4">
          <div class="glass-card crystal-border rounded-2xl p-6 gem-glow">
            <div class="text-center mb-6">
              <div class="text-xs text-purple-400 font-bold mb-1">å³æ™‚åŒ¯ç‡</div>
              <div class="text-2xl font-black gem-text">1 TWD = {{ exchangeRate }} JPY</div>
              <div class="text-xs text-white/40 mt-1">æ›´æ–°æ™‚é–“ï¼š{{ rateUpdateTime }}</div>
            </div>
            
            <div class="space-y-4">
              <div class="glass-card rounded-xl p-4">
                <label class="text-xs text-white/50 block mb-2">ğŸ‡¹ğŸ‡¼ å°å¹£ TWD</label>
                <input type="number" v-model="twdAmount" @input="convertToJpy"
                       class="w-full bg-transparent text-2xl font-bold text-white outline-none"
                       placeholder="0">
              </div>
              
              <div class="text-center text-white/30">â†“â†‘</div>
              
              <div class="glass-card rounded-xl p-4">
                <label class="text-xs text-white/50 block mb-2">ğŸ‡¯ğŸ‡µ æ—¥åœ“ JPY</label>
                <input type="number" v-model="jpyAmount" @input="convertToTwd"
                       class="w-full bg-transparent text-2xl font-bold text-white outline-none"
                       placeholder="0">
              </div>
            </div>
          </div>
          
          <div class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-white mb-3">ğŸ’¡ å¿«é€Ÿæ›ç®—</h3>
            <div class="grid grid-cols-2 gap-2">
              <div v-for="amt in [1000, 5000, 10000, 50000]" :key="amt" 
                   @click="twdAmount = amt; convertToJpy()"
                   class="glass-card p-3 rounded-xl text-center cursor-pointer hover:bg-white/10 transition-colors">
                <div class="text-xs text-white/50">{{ amt.toLocaleString() }} TWD</div>
                <div class="text-sm font-bold gem-text">â‰ˆ {{ Math.round(amt * exchangeRate).toLocaleString() }} JPY</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Phrasebook -->
        <div v-else-if="activeKind === 'phrase'" class="grid grid-cols-1 gap-3">
          <div v-for="p in config.phrasebook" @click="speak(p.jp)" class="glass-card p-4 rounded-2xl active:scale-[0.98] transition-all cursor-pointer hover:bg-white/[0.08] group">
            <div class="text-xs font-bold text-purple-400 mb-1">{{ p.label }}</div>
            <div class="text-lg font-bold text-white">{{ p.jp }}</div>
            <div class="flex justify-between items-center mt-2">
              <div class="text-[10px] text-white/40">{{ p.note }}</div>
              <div class="text-[10px] bg-white/10 text-white/60 px-2.5 py-1 rounded-full group-hover:bg-purple-500/30 group-hover:text-purple-300 transition-colors">ğŸ”Š æ’­æ”¾</div>
            </div>
          </div>
        </div>

        <!-- Photos -->
        <div v-else-if="activeKind === 'photos'" class="space-y-4">
          <div class="glass-card crystal-border rounded-2xl p-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-sm font-bold text-white">ğŸ“¸ æ—…é€”å›æ†¶</h3>
              <label class="glass-card px-3 py-1.5 rounded-lg text-xs font-bold text-purple-300 cursor-pointer hover:bg-white/10 transition-colors">
                + æ–°å¢ç…§ç‰‡
                <input type="file" accept="image/*" multiple @change="addPhotos" class="hidden">
              </label>
            </div>
            
            <div v-if="photos.length === 0" class="text-center py-8 text-white/30">
              <div class="text-4xl mb-2">ğŸ“·</div>
              <div class="text-sm">é‚„æ²’æœ‰ç…§ç‰‡</div>
              <div class="text-xs">é–‹å§‹æ—…ç¨‹å¾Œè¨˜éŒ„ç¾å¥½å›æ†¶å§ï¼</div>
            </div>
            
            <div v-else class="photo-grid">
              <div v-for="(photo, idx) in photos" :key="idx" class="relative group">
                <img :src="photo.data" class="photo-item w-full cursor-pointer" @click="viewPhoto(idx)">
                <button @click.stop="removePhoto(idx)" class="absolute top-1 right-1 w-6 h-6 bg-red-500/80 rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity">Ã—</button>
              </div>
            </div>
          </div>
          
          <div v-if="photos.length > 0" class="text-center text-xs text-white/30">
            å…± {{ photos.length }} å¼µç…§ç‰‡
          </div>
        </div>

        <!-- Weather -->
        <div v-else-if="activeKind === 'weather'" class="space-y-4">
          <div class="glass-card crystal-border rounded-2xl p-6 text-center gem-glow">
            <div class="text-6xl mb-2">{{ weatherData.icon }}</div>
            <div class="text-4xl font-black gem-text">{{ weatherData.temp }}Â°C</div>
            <div class="text-white/60 mt-1">{{ weatherData.description }}</div>
            <div class="text-xs text-white/40 mt-2">æ±äº¬ Â· {{ weatherData.updateTime }}</div>
          </div>
          
          <div class="grid grid-cols-3 gap-3">
            <div class="glass-card rounded-xl p-3 text-center">
              <div class="text-xl mb-1">ğŸ’§</div>
              <div class="text-lg font-bold text-white">{{ weatherData.humidity }}%</div>
              <div class="text-xs text-white/40">æ¿•åº¦</div>
            </div>
            <div class="glass-card rounded-xl p-3 text-center">
              <div class="text-xl mb-1">ğŸ’¨</div>
              <div class="text-lg font-bold text-white">{{ weatherData.wind }} m/s</div>
              <div class="text-xs text-white/40">é¢¨é€Ÿ</div>
            </div>
            <div class="glass-card rounded-xl p-3 text-center">
              <div class="text-xl mb-1">ğŸŒ¡ï¸</div>
              <div class="text-lg font-bold text-white">{{ weatherData.feelsLike }}Â°C</div>
              <div class="text-xs text-white/40">é«”æ„Ÿ</div>
            </div>
          </div>
          
          <div class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-white mb-3">æœªä¾† 5 å¤©</h3>
            <div class="space-y-2">
              <div v-for="day in weatherForecast" :key="day.date" class="flex justify-between items-center p-2 rounded-lg hover:bg-white/5">
                <div class="text-sm text-white/70">{{ day.date }}</div>
                <div class="text-xl">{{ day.icon }}</div>
                <div class="text-sm font-bold text-white">{{ day.high }}Â° / {{ day.low }}Â°</div>
              </div>
            </div>
          </div>
          
          <button @click="refreshWeather" class="w-full glass-card py-3 rounded-xl text-sm font-bold text-purple-300 hover:bg-white/10 transition-colors">
            ğŸ”„ æ›´æ–°å¤©æ°£
          </button>
        </div>

        <!-- Emergency -->
        <div v-else-if="activeKind === 'emergency'" class="space-y-4">
          <div class="glass-card crystal-border rounded-2xl p-4 border-l-4 border-l-red-500">
            <h3 class="text-sm font-bold text-red-400 mb-3">ğŸ†˜ ç·Šæ€¥è¯çµ¡</h3>
            <div class="space-y-3">
              <a href="tel:110" class="flex items-center gap-3 p-3 bg-red-500/20 rounded-xl">
                <span class="text-2xl">ğŸ‘®</span>
                <div>
                  <div class="font-bold text-white">è­¦å¯Ÿ</div>
                  <div class="text-xs text-white/50">110</div>
                </div>
              </a>
              <a href="tel:119" class="flex items-center gap-3 p-3 bg-orange-500/20 rounded-xl">
                <span class="text-2xl">ğŸš‘</span>
                <div>
                  <div class="font-bold text-white">æ•‘è­·è»Š / æ¶ˆé˜²</div>
                  <div class="text-xs text-white/50">119</div>
                </div>
              </a>
            </div>
          </div>
          
          <div class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-white mb-3">ğŸ›ï¸ å°ç£é§æ—¥ä»£è¡¨è™•</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-white/50">åœ°å€</span>
                <span class="text-white">æ±äº¬éƒ½æ¸¯åŒºç™½é‡‘å°5-20-2</span>
              </div>
              <div class="flex justify-between">
                <span class="text-white/50">é›»è©±</span>
                <a href="tel:+81-3-3280-7811" class="text-purple-400">03-3280-7811</a>
              </div>
              <div class="flex justify-between">
                <span class="text-white/50">æ€¥é›£æ•‘åŠ©</span>
                <a href="tel:+81-80-6552-4764" class="text-purple-400">080-6552-4764</a>
              </div>
            </div>
          </div>
          
          <div class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-white mb-3">ğŸ¨ ä½å®¿è³‡è¨Š</h3>
            <div v-for="s in config.stays" :key="s.id" class="p-3 bg-white/5 rounded-xl mb-2">
              <div class="font-bold text-white text-sm">{{ s.name }}</div>
              <div class="text-xs text-white/50 mt-1">{{ s.area }}</div>
              <div class="text-xs text-white/50">{{ shortDate(s.checkIn) }} - {{ shortDate(s.checkOut) }}</div>
            </div>
          </div>
          
          <div class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-white mb-3">ğŸ’Š å¸¸ç”¨æ—¥èªï¼ˆç·Šæ€¥ï¼‰</h3>
            <div class="space-y-2">
              <div @click="speak('åŠ©ã‘ã¦ãã ã•ã„')" class="p-2 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10">
                <div class="text-sm text-white">åŠ©ã‘ã¦ãã ã•ã„</div>
                <div class="text-xs text-white/40">è«‹å¹«å¹«æˆ‘</div>
              </div>
              <div @click="speak('ç—…é™¢ã¯ã©ã“ã§ã™ã‹')" class="p-2 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10">
                <div class="text-sm text-white">ç—…é™¢ã¯ã©ã“ã§ã™ã‹</div>
                <div class="text-xs text-white/40">é†«é™¢åœ¨å“ªè£¡ï¼Ÿ</div>
              </div>
              <div @click="speak('è­¦å¯Ÿã‚’å‘¼ã‚“ã§ãã ã•ã„')" class="p-2 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10">
                <div class="text-sm text-white">è­¦å¯Ÿã‚’å‘¼ã‚“ã§ãã ã•ã„</div>
                <div class="text-xs text-white/40">è«‹å«è­¦å¯Ÿ</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Share -->
        <div v-else-if="activeKind === 'share'" class="space-y-4">
          <div class="glass-card crystal-border rounded-2xl p-6 text-center gem-glow">
            <h3 class="text-sm font-bold text-white mb-4">ğŸ”— åˆ†äº«è¡Œç¨‹</h3>
            <div id="qrcode" class="inline-block p-4 bg-white rounded-2xl mb-4"></div>
            <div class="text-xs text-white/50 mb-4">æƒæ QR Code æŸ¥çœ‹è¡Œç¨‹</div>
            <button @click="copyLink" class="w-full glass-card py-3 rounded-xl text-sm font-bold text-purple-300 hover:bg-white/10 transition-colors">
              ğŸ“‹ è¤‡è£½é€£çµ
            </button>
          </div>
          
          <div class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-white mb-3">ğŸ“± åˆ†äº«åˆ°</h3>
            <div class="grid grid-cols-3 gap-3">
              <a :href="'https://line.me/R/msg/text/?' + encodeURIComponent('2026æ±äº¬æ—…è¡Œ ' + shareUrl)" target="_blank" class="glass-card p-4 rounded-xl text-center hover:bg-white/10 transition-colors">
                <div class="text-2xl mb-1">ğŸ’¬</div>
                <div class="text-xs text-white/60">LINE</div>
              </a>
              <a :href="'mailto:?subject=2026æ±äº¬æ—…è¡Œ&body=' + encodeURIComponent(shareUrl)" class="glass-card p-4 rounded-xl text-center hover:bg-white/10 transition-colors">
                <div class="text-2xl mb-1">ğŸ“§</div>
                <div class="text-xs text-white/60">Email</div>
              </a>
              <button @click="nativeShare" class="glass-card p-4 rounded-xl text-center hover:bg-white/10 transition-colors">
                <div class="text-2xl mb-1">ğŸ“¤</div>
                <div class="text-xs text-white/60">å…¶ä»–</div>
              </button>
            </div>
          </div>
        </div>

        <!-- Budget -->
        <div v-else-if="activeKind === 'budget'" class="space-y-4">
          <div class="glass-card crystal-border rounded-2xl p-6 text-center relative overflow-hidden gem-glow">
            <div class="absolute inset-0 shimmer pointer-events-none"></div>
            <div class="relative z-10">
              <div class="text-xs font-bold text-teal-400 mb-2 tracking-wider">Total Expenses</div>
              <div class="text-5xl font-black gem-text">{{ totalBudget() }}</div>
              <div class="text-sm font-bold text-white/50 mt-1">{{ config.budget.currency }}</div>
            </div>
          </div>
          
          <div class="space-y-2">
            <div v-for="d in config.days" class="glass-card p-4 rounded-xl flex justify-between items-center hover:bg-white/[0.08] transition-colors">
              <div>
                <div class="font-bold text-white text-sm">{{ d.label }}</div>
                <div class="text-xs text-white/40">{{ shortDate(d.date) }}</div>
              </div>
              <div class="font-mono font-bold text-lg gem-text">{{ dayTotal(d.date) }}</div>
            </div>
          </div>
          
          <button @click="clearAllBudget" class="w-full py-4 text-xs font-bold text-white/30 hover:text-red-400 transition-colors">âš ï¸ æ¸…é™¤æ‰€æœ‰è¨˜éŒ„</button>
        </div>

      </main>
    </div>
    
    <!-- Photo Viewer Modal -->
    <div v-if="viewingPhoto !== null" @click="viewingPhoto = null" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
      <img :src="photos[viewingPhoto]?.data" class="max-w-full max-h-full object-contain rounded-lg">
      <button @click="viewingPhoto = null" class="absolute top-4 right-4 w-10 h-10 bg-white/20 rounded-full text-xl">Ã—</button>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
    const BUDGET_KEY = "trip-budget-v2";
    const PACKING_KEY = "trip-packing-v1";
    const PHOTOS_KEY = "trip-photos-v1";

    createApp({
      setup() {
        const config = ref(null);
        const loading = ref(true);
        const activeKind = ref('overview');
        const activeDayDate = ref('');
        const budgetData = ref({});
        const packedItems = ref({});
        const photos = ref([]);
        const viewingPhoto = ref(null);
        
        // Currency
        const twdAmount = ref('');
        const jpyAmount = ref('');
        const exchangeRate = ref(4.6); // Default rate
        const rateUpdateTime = ref('--');
        
        // Weather
        const weatherData = ref({
          icon: 'â˜€ï¸',
          temp: '--',
          description: 'è¼‰å…¥ä¸­...',
          humidity: '--',
          wind: '--',
          feelsLike: '--',
          updateTime: '--'
        });
        const weatherForecast = ref([]);
        
        // Map
        let map = null;
        
        // Share
        const shareUrl = window.location.href;

        // Packing categories
        const packingCategories = ref([
          { name: 'è­‰ä»¶æ–‡ä»¶', icon: 'ğŸ“„', items: ['è­·ç…§', 'èº«åˆ†è­‰', 'æ©Ÿç¥¨', 'é£¯åº—è¨‚æˆ¿ç¢ºèª', 'æ—…å¹³éšªä¿å–®', 'æ—¥å¹£ç¾é‡‘', 'ä¿¡ç”¨å¡'] },
          { name: 'é›»å­ç”¢å“', icon: 'ğŸ”Œ', items: ['æ‰‹æ©Ÿ', 'å……é›»å™¨', 'è¡Œå‹•é›»æº', 'ç›¸æ©Ÿ', 'è¨˜æ†¶å¡', 'è½‰æ¥é ­', 'è€³æ©Ÿ'] },
          { name: 'è¡£ç‰©', icon: 'ğŸ‘•', items: ['ä¸Šè¡£ x3', 'è¤²å­ x2', 'å…§è¡£è¤² x4', 'å¤–å¥—', 'ç¡è¡£', 'è¥ªå­ x4', 'èˆ’é©èµ°è·¯é‹'] },
          { name: 'ç›¥æ´—ç”¨å“', icon: 'ğŸ§´', items: ['ç‰™åˆ·ç‰™è†', 'æ´—é¢ä¹³', 'ä¿é¤Šå“', 'é˜²æ›¬ä¹³', 'æ¢³å­', 'æ¯›å·¾'] },
          { name: 'å…¶ä»–', icon: 'ğŸ’', items: ['é›¨å‚˜/é›¨è¡£', 'è—¥å“', 'é›¶é£Ÿ', 'æ°´å£º', 'è³¼ç‰©è¢‹', 'æ—…éŠæ›¸'] }
        ]);

        // Icons map
        const getBlockIcon = (type) => {
          const map = {
            'transport': 'ğŸš†',
            'packingToday': 'ğŸ’',
            'todo': 'âœ…',
            'mealOptions': 'ğŸ”',
            'dinnerRecommend': 'ğŸ½ï¸',
            'note': 'ğŸ“'
          };
          return map[type] || 'ğŸ“';
        };

        // Helpers
        const shortDate = (s) => s ? s.split('-').slice(1).join('/') : '';
        const dateOnly = (s) => s ? s.split('T')[0] : '';
        const timeOnly = (s) => s ? s.split('T')[1]?.substring(0,5) : '';
        const stayName = (id) => config.value?.stays.find(s => s.id === id)?.name;

        // Countdown
        const countdownDays = computed(() => {
          if (!config.value) return '--';
          const start = new Date(config.value.tripMeta.startDate);
          const now = new Date();
          const diff = Math.ceil((start - now) / (1000 * 60 * 60 * 24));
          if (diff < 0) return Math.abs(diff);
          return diff;
        });
        
        const countdownLabel = computed(() => {
          if (!config.value) return '';
          const start = new Date(config.value.tripMeta.startDate);
          const end = new Date(config.value.tripMeta.endDate);
          const now = new Date();
          if (now < start) return 'è·é›¢å‡ºç™¼é‚„æœ‰';
          if (now >= start && now <= end) return 'æ—…ç¨‹é€²è¡Œä¸­ï¼ç¬¬';
          return 'æ—…ç¨‹çµæŸ';
        });
        
        const countdownSubtext = computed(() => {
          if (!config.value) return '';
          const start = new Date(config.value.tripMeta.startDate);
          const end = new Date(config.value.tripMeta.endDate);
          const now = new Date();
          if (now < start) return 'å¤©';
          if (now >= start && now <= end) return 'å¤©';
          return 'å¤©å‰çµæŸ';
        });

        // Compute
        const currentDay = computed(() => config.value?.days.find(d => d.date === activeDayDate.value));

        // Logic
        const selectDay = (date) => {
           activeKind.value = 'day';
           activeDayDate.value = date;
        };
        
        const speak = (text) => {
           const u = new SpeechSynthesisUtterance(text);
           u.lang = 'ja-JP';
           window.speechSynthesis.speak(u);
        };

        // Budget
        const loadBudget = () => {
           try {
              const raw = localStorage.getItem(BUDGET_KEY);
              if(raw) budgetData.value = JSON.parse(raw);
           } catch(e) {}
        };
        const saveBudget = () => localStorage.setItem(BUDGET_KEY, JSON.stringify(budgetData.value));
        const dayTotal = (date) => (budgetData.value[date] || []).reduce((a,b) => a + Number(b.amount), 0);
        const totalBudget = () => Object.values(budgetData.value).flat().reduce((a,b) => a + Number(b.amount), 0);
        const clearAllBudget = () => {
           if(confirm('æ¸…é™¤æ‰€æœ‰è¨˜å¸³è³‡æ–™ï¼Ÿ')) {
              budgetData.value = {};
              saveBudget();
           }
        };

        // Packing
        const loadPacking = () => {
          try {
            const raw = localStorage.getItem(PACKING_KEY);
            if(raw) packedItems.value = JSON.parse(raw);
          } catch(e) {}
        };
        const savePacking = () => localStorage.setItem(PACKING_KEY, JSON.stringify(packedItems.value));
        const togglePackingItem = (cat, item) => {
          const key = `${cat}:${item}`;
          if(packedItems.value[key]) {
            delete packedItems.value[key];
          } else {
            packedItems.value[key] = true;
          }
          savePacking();
        };
        const isPackedItem = (cat, item) => !!packedItems.value[`${cat}:${item}`];
        const packingProgress = computed(() => {
          const total = packingCategories.value.reduce((sum, cat) => sum + cat.items.length, 0);
          const packed = Object.keys(packedItems.value).length;
          return Math.round((packed / total) * 100);
        });
        const resetPacking = () => {
          if(confirm('é‡ç½®æ‰€æœ‰æ‰“åŒ…é€²åº¦ï¼Ÿ')) {
            packedItems.value = {};
            savePacking();
          }
        };

        // Currency
        const convertToJpy = () => {
          if(twdAmount.value) {
            jpyAmount.value = Math.round(twdAmount.value * exchangeRate.value);
          } else {
            jpyAmount.value = '';
          }
        };
        const convertToTwd = () => {
          if(jpyAmount.value) {
            twdAmount.value = Math.round(jpyAmount.value / exchangeRate.value);
          } else {
            twdAmount.value = '';
          }
        };
        const fetchExchangeRate = async () => {
          try {
            // Using a free API or fallback to default
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
            const data = await res.json();
            exchangeRate.value = data.rates.JPY.toFixed(2);
            rateUpdateTime.value = new Date().toLocaleTimeString('zh-TW');
          } catch(e) {
            rateUpdateTime.value = 'ä½¿ç”¨é è¨­åŒ¯ç‡';
          }
        };

        // Weather
        const refreshWeather = async () => {
          try {
            // Using Open-Meteo (free, no API key)
            const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.6762&longitude=139.6503&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo');
            const data = await res.json();
            
            const weatherIcons = {
              0: 'â˜€ï¸', 1: 'ğŸŒ¤ï¸', 2: 'â›…', 3: 'â˜ï¸',
              45: 'ğŸŒ«ï¸', 48: 'ğŸŒ«ï¸',
              51: 'ğŸŒ§ï¸', 53: 'ğŸŒ§ï¸', 55: 'ğŸŒ§ï¸',
              61: 'ğŸŒ§ï¸', 63: 'ğŸŒ§ï¸', 65: 'ğŸŒ§ï¸',
              71: 'â„ï¸', 73: 'â„ï¸', 75: 'â„ï¸',
              80: 'ğŸŒ§ï¸', 81: 'ğŸŒ§ï¸', 82: 'ğŸŒ§ï¸',
              95: 'â›ˆï¸', 96: 'â›ˆï¸', 99: 'â›ˆï¸'
            };
            
            const weatherDesc = {
              0: 'æ™´æœ—', 1: 'å¤§è‡´æ™´æœ—', 2: 'å±€éƒ¨å¤šé›²', 3: 'å¤šé›²',
              45: 'æœ‰éœ§', 48: 'æœ‰éœ§',
              51: 'å°é›¨', 53: 'ä¸­é›¨', 55: 'å¤§é›¨',
              61: 'å°é›¨', 63: 'ä¸­é›¨', 65: 'å¤§é›¨',
              71: 'å°é›ª', 73: 'ä¸­é›ª', 75: 'å¤§é›ª',
              80: 'é™£é›¨', 81: 'é™£é›¨', 82: 'å¤§é™£é›¨',
              95: 'é›·é›¨', 96: 'é›·é›¨', 99: 'é›·é›¨'
            };
            
            const code = data.current.weather_code;
            weatherData.value = {
              icon: weatherIcons[code] || 'ğŸŒ¤ï¸',
              temp: Math.round(data.current.temperature_2m),
              description: weatherDesc[code] || 'æœªçŸ¥',
              humidity: data.current.relative_humidity_2m,
              wind: data.current.wind_speed_10m,
              feelsLike: Math.round(data.current.apparent_temperature),
              updateTime: new Date().toLocaleTimeString('zh-TW')
            };
            
            // Forecast
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weatherForecast.value = data.daily.time.slice(1, 6).map((date, i) => {
              const d = new Date(date);
              return {
                date: `${d.getMonth()+1}/${d.getDate()} (${days[d.getDay()]})`,
                icon: weatherIcons[data.daily.weather_code[i+1]] || 'ğŸŒ¤ï¸',
                high: Math.round(data.daily.temperature_2m_max[i+1]),
                low: Math.round(data.daily.temperature_2m_min[i+1])
              };
            });
          } catch(e) {
            console.error('Weather fetch error:', e);
          }
        };

        // Photos
        const loadPhotos = () => {
          try {
            const raw = localStorage.getItem(PHOTOS_KEY);
            if(raw) photos.value = JSON.parse(raw);
          } catch(e) {}
        };
        const savePhotos = () => {
          try {
            localStorage.setItem(PHOTOS_KEY, JSON.stringify(photos.value));
          } catch(e) {
            alert('ç…§ç‰‡å¤ªå¤šï¼Œå„²å­˜ç©ºé–“ä¸è¶³ï¼');
          }
        };
        const addPhotos = (e) => {
          const files = e.target.files;
          for(let file of files) {
            const reader = new FileReader();
            reader.onload = (ev) => {
              // Compress image
              const img = new Image();
              img.onload = () => {
                const canvas = document.createElement('canvas');
                const maxSize = 800;
                let w = img.width, h = img.height;
                if(w > h && w > maxSize) { h = h * maxSize / w; w = maxSize; }
                else if(h > maxSize) { w = w * maxSize / h; h = maxSize; }
                canvas.width = w;
                canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                photos.value.push({
                  data: canvas.toDataURL('image/jpeg', 0.7),
                  date: new Date().toISOString()
                });
                savePhotos();
              };
              img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
          }
        };
        const removePhoto = (idx) => {
          if(confirm('åˆªé™¤é€™å¼µç…§ç‰‡ï¼Ÿ')) {
            photos.value.splice(idx, 1);
            savePhotos();
          }
        };
        const viewPhoto = (idx) => {
          viewingPhoto.value = idx;
        };

        // Map
        const initMap = () => {
          if(map) return;
          nextTick(() => {
            const container = document.getElementById('map-container');
            if(!container) return;
            
            map = L.map('map-container', {
              zoomControl: false
            }).setView([35.6762, 139.7503], 11);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
              attribution: 'Â© CartoDB'
            }).addTo(map);
            
            // Add markers from stays
            if(config.value?.stays) {
              config.value.stays.forEach(s => {
                if(s.lat && s.lng) {
                  L.circleMarker([s.lat, s.lng], {
                    radius: 8,
                    fillColor: '#3b82f6',
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 0.8
                  }).addTo(map).bindPopup(`<b>${s.name}</b><br>${s.area}`);
                }
              });
            }
            
            // Sample landmarks
            const landmarks = [
              { name: 'æ±äº¬è»Šç«™', lat: 35.6812, lng: 139.7671, type: 'spot' },
              { name: 'æ·ºè‰å¯º', lat: 35.7148, lng: 139.7967, type: 'spot' },
              { name: 'æ±äº¬å¡”', lat: 35.6586, lng: 139.7454, type: 'spot' },
              { name: 'æ–°å®¿', lat: 35.6896, lng: 139.7006, type: 'shop' },
              { name: 'æ¾€è°·', lat: 35.6580, lng: 139.7016, type: 'shop' }
            ];
            
            landmarks.forEach(l => {
              const color = l.type === 'spot' ? '#a855f7' : '#14b8a6';
              L.circleMarker([l.lat, l.lng], {
                radius: 6,
                fillColor: color,
                color: '#fff',
                weight: 2,
                fillOpacity: 0.8
              }).addTo(map).bindPopup(`<b>${l.name}</b>`);
            });
          });
        };

        // Share
        const generateQR = () => {
          nextTick(() => {
            const container = document.getElementById('qrcode');
            if(!container || container.hasChildNodes()) return;
            
            const qr = qrcode(0, 'M');
            qr.addData(shareUrl);
            qr.make();
            container.innerHTML = qr.createImgTag(5, 0);
          });
        };
        
        const copyLink = async () => {
          try {
            await navigator.clipboard.writeText(shareUrl);
            alert('å·²è¤‡è£½é€£çµï¼');
          } catch(e) {
            prompt('è¤‡è£½æ­¤é€£çµï¼š', shareUrl);
          }
        };
        
        const nativeShare = async () => {
          if(navigator.share) {
            try {
              await navigator.share({
                title: '2026 æ±äº¬å®¶åº­æ—…è¡Œ',
                url: shareUrl
              });
            } catch(e) {}
          } else {
            copyLink();
          }
        };

        // Watch for tab changes
        watch(activeKind, (val) => {
          if(val === 'map') initMap();
          if(val === 'share') generateQR();
          if(val === 'weather' && weatherData.value.temp === '--') refreshWeather();
        });

        onMounted(async () => {
          try {
             const res = await fetch('./trip-config.json?t=' + Date.now());
             config.value = await res.json();
             if(config.value.days.length) activeDayDate.value = config.value.days[0].date;
             loadBudget();
             loadPacking();
             loadPhotos();
             fetchExchangeRate();
          } catch(e) { console.error(e); } 
          finally { loading.value = false; }
          
          // Register service worker
          if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(e => console.log('SW:', e));
          }
        });

        return {
           config, loading, activeKind, activeDayDate, currentDay,
           shortDate, dateOnly, timeOnly, stayName, getBlockIcon,
           selectDay, speak,
           // Countdown
           countdownDays, countdownLabel, countdownSubtext,
           // Budget
           dayTotal, totalBudget, clearAllBudget,
           // Packing
           packingCategories, packingProgress, togglePackingItem, isPackedItem, resetPacking,
           // Currency
           twdAmount, jpyAmount, exchangeRate, rateUpdateTime, convertToJpy, convertToTwd,
           // Weather
           weatherData, weatherForecast, refreshWeather,
           // Photos
           photos, viewingPhoto, addPhotos, removePhoto, viewPhoto,
           // Share
           shareUrl, copyLink, nativeShare
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
