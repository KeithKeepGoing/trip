<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2026 æ±äº¬å®¶åº­æ—…è¡Œ ğŸŒ¸</title>
  <meta name="description" content="2026å¹´æ±äº¬å®¶åº­æ—…è¡Œè¡Œç¨‹è¦åŠƒ - æ«»èŠ±é¢¨æ ¼äº’å‹•å¼æ—…éŠæŒ‡å—">
  <meta name="theme-color" content="#fdf2f8">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --sakura-50: #fdf2f8;
      --sakura-100: #fce7f3;
      --sakura-200: #fbcfe8;
      --sakura-300: #f9a8d4;
      --sakura-400: #f472b6;
      --sakura-500: #ec4899;
      --sakura-600: #db2777;
      --rose-warm: #fff1f2;
    }
    
    body {
      font-family: 'Zen Maru Gothic', sans-serif;
      background: linear-gradient(180deg, #fff1f2 0%, #fdf2f8 50%, #fce7f3 100%);
      min-height: 100vh;
    }
    
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    
    .sakura-pattern {
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(244, 114, 182, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(251, 207, 232, 0.2) 0%, transparent 40%);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: 
        0 4px 30px rgba(236, 72, 153, 0.1),
        0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .sakura-glow {
      box-shadow: 
        0 0 30px rgba(244, 114, 182, 0.2),
        0 0 60px rgba(251, 207, 232, 0.3);
    }
    
    .sakura-text {
      background: linear-gradient(135deg, #ec4899 0%, #f472b6 50%, #db2777 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .sakura-border {
      position: relative;
    }
    .sakura-border::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: 2px;
      background: linear-gradient(135deg, #f9a8d4, #f472b6, #fce7f3);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(5deg); }
    }
    
    @keyframes fall {
      0% { transform: translateY(-10px) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }
    
    @keyframes pulse-soft {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    
    .float-anim {
      animation: float 4s ease-in-out infinite;
    }
    
    .petal {
      position: fixed;
      pointer-events: none;
      z-index: 100;
      animation: fall linear infinite;
    }
    
    .nav-btn {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .nav-btn:hover {
      transform: translateY(-2px);
    }
    .nav-btn.active {
      background: linear-gradient(135deg, #fce7f3, #fbcfe8);
      border-color: #f9a8d4;
      color: #be185d;
      box-shadow: 0 4px 15px rgba(244, 114, 182, 0.3);
    }
    
    .timeline-line {
      background: linear-gradient(180deg, #f9a8d4 0%, #fbcfe8 50%, #f9a8d4 100%);
    }
    
    .timeline-dot {
      background: linear-gradient(135deg, #f472b6, #ec4899);
      box-shadow: 0 0 10px rgba(244, 114, 182, 0.5);
    }
    
    .checklist-item.checked {
      opacity: 0.5;
      text-decoration: line-through;
    }
    
    #map-container {
      height: 300px;
      border-radius: 1rem;
      overflow: hidden;
    }
    
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }
    
    .photo-item {
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 0.75rem;
    }

    /* Falling petals */
    .petal-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
      z-index: 50;
    }
  </style>
</head>
<body class="sakura-pattern min-h-screen text-slate-700 pb-20">
  <!-- Falling Petals -->
  <div class="petal-container" id="petals"></div>
  
  <div id="app" class="max-w-md mx-auto min-h-screen relative">
    
    <!-- Loading -->
    <div v-if="loading" class="flex flex-col items-center justify-center h-screen space-y-6">
      <div class="text-6xl float-anim">ğŸŒ¸</div>
      <div class="sakura-text font-bold tracking-[0.3em] text-sm">LOADING...</div>
      <div class="w-32 h-1 rounded-full overflow-hidden bg-pink-100">
        <div class="h-full bg-gradient-to-r from-pink-300 via-pink-400 to-pink-300 animate-pulse"></div>
      </div>
    </div>

    <div v-else class="pb-24">
      <!-- Hero -->
      <header class="relative pt-10 pb-20 px-6 overflow-hidden">
        <!-- Decorative elements -->
        <div class="absolute top-5 right-5 text-5xl opacity-30 float-anim">ğŸŒ¸</div>
        <div class="absolute top-20 left-8 text-3xl opacity-20 float-anim" style="animation-delay: -1s;">ğŸŒ¸</div>
        <div class="absolute bottom-10 right-10 text-4xl opacity-25 float-anim" style="animation-delay: -2s;">ğŸŒ¸</div>
        
        <div class="relative z-10 text-center">
          <div class="inline-flex items-center gap-2 bg-white/60 backdrop-blur border border-pink-200 rounded-full px-4 py-1.5 mb-4 shadow-sm">
            <span class="text-lg">ğŸŒ¸</span>
            <span class="text-xs font-bold text-pink-600 tracking-wider uppercase">Tokyo Trip 2026</span>
          </div>
          
          <h1 class="text-4xl font-black tracking-tight leading-tight mb-3">
            <span class="sakura-text">{{ config.tripMeta.title }}</span>
          </h1>
          <p class="text-pink-400 text-sm font-medium">{{ config.tripMeta.subtitle }}</p>
          
          <!-- Countdown -->
          <div class="mt-6 glass-card sakura-border rounded-2xl p-5 sakura-glow">
            <div class="text-xs text-pink-500 font-bold mb-1">{{ countdownLabel }}</div>
            <div class="text-4xl font-black sakura-text">{{ countdownDays }}</div>
            <div class="text-xs text-pink-400/70 mt-1">{{ countdownSubtext }}</div>
          </div>
          
          <div class="mt-6 flex justify-center gap-3">
            <div class="glass-card px-4 py-2 rounded-xl text-xs font-semibold flex items-center gap-2">
              <span class="text-pink-500">ğŸ“…</span>
              <span class="text-slate-600">{{ shortDate(config.tripMeta.startDate) }} - {{ shortDate(config.tripMeta.endDate) }}</span>
            </div>
            <div class="glass-card px-4 py-2 rounded-xl text-xs font-semibold flex items-center gap-2">
              <span class="text-pink-500">ğŸ“</span>
              <span class="text-slate-600">{{ config.tripMeta.baseCity }}</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Floating Nav -->
      <div class="sticky top-0 z-30 px-4 -mt-8 mb-6">
        <div class="glass-card rounded-2xl p-2 shadow-lg">
          <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide snap-x">
            <button 
              @click="activeKind = 'overview'"
              class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold border border-pink-100 bg-white/50"
              :class="activeKind === 'overview' ? 'active' : 'text-slate-500 hover:text-pink-600 hover:bg-pink-50'"
            >ğŸŒ¸ ç¸½è¦½</button>
            <button 
              v-for="day in config.days" 
              :key="day.date"
              @click="selectDay(day.date)"
              class="nav-btn snap-start flex-shrink-0 px-3 py-2 rounded-xl border border-pink-100 bg-white/50 flex flex-col items-center justify-center min-w-[60px]"
              :class="activeKind === 'day' && activeDayDate === day.date ? 'active' : 'text-slate-500 hover:text-pink-600 hover:bg-pink-50'"
            >
              <span class="text-[10px] font-bold">{{ day.label }}</span>
              <span class="text-[9px] opacity-50">{{ shortDate(day.date) }}</span>
            </button>
            <button @click="activeKind = 'map'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold border border-pink-100 bg-white/50" :class="activeKind === 'map' ? 'active' : 'text-slate-500'">ğŸ—ºï¸ åœ°åœ–</button>
            <button @click="activeKind = 'packing'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold border border-pink-100 bg-white/50" :class="activeKind === 'packing' ? 'active' : 'text-slate-500'">ğŸ“¦ æ‰“åŒ…</button>
            <button @click="activeKind = 'budget'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold border border-pink-100 bg-white/50" :class="activeKind === 'budget' ? 'active' : 'text-slate-500'">ğŸ’° è¨˜å¸³</button>
            <button @click="activeKind = 'currency'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold border border-pink-100 bg-white/50" :class="activeKind === 'currency' ? 'active' : 'text-slate-500'">ğŸ’± åŒ¯ç‡</button>
            <button @click="activeKind = 'phrase'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold border border-pink-100 bg-white/50" :class="activeKind === 'phrase' ? 'active' : 'text-slate-500'">ğŸ—£ï¸ æ—¥èª</button>
            <button @click="activeKind = 'photos'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold border border-pink-100 bg-white/50" :class="activeKind === 'photos' ? 'active' : 'text-slate-500'">ğŸ“¸ ç…§ç‰‡</button>
            <button @click="activeKind = 'weather'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold border border-pink-100 bg-white/50" :class="activeKind === 'weather' ? 'active' : 'text-slate-500'">â˜ï¸ å¤©æ°£</button>
            <button @click="activeKind = 'emergency'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold border border-pink-100 bg-white/50" :class="activeKind === 'emergency' ? 'active' : 'text-slate-500'">ğŸ†˜ ç·Šæ€¥</button>
            <button @click="activeKind = 'share'" class="nav-btn snap-start flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold border border-pink-100 bg-white/50" :class="activeKind === 'share' ? 'active' : 'text-slate-500'">ğŸ”— åˆ†äº«</button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <main class="px-5 space-y-6">

        <!-- Overview -->
        <div v-if="activeKind === 'overview'" class="space-y-6">
          <!-- Flight Card -->
          <section>
            <h3 class="text-xs font-bold text-pink-400 uppercase tracking-widest mb-3 pl-1 flex items-center gap-2">
              <span class="w-4 h-px bg-pink-300"></span>
              Flights âœˆï¸
            </h3>
            <div v-for="f in config.flights" :key="f.id" class="mb-3 glass-card sakura-border rounded-2xl p-5 relative overflow-hidden">
              <div class="absolute -top-5 -right-5 text-7xl opacity-10">âœˆï¸</div>
              <div class="flex justify-between items-center mb-4 relative z-10">
                <span class="bg-pink-100 text-pink-600 text-[10px] font-bold px-2.5 py-1 rounded-lg">{{ f.airline }}</span>
                <span class="text-xs font-bold text-slate-400">{{ dateOnly(f.departure) }}</span>
              </div>
              <div class="flex justify-between items-center relative z-10">
                <div>
                  <div class="text-3xl font-black sakura-text">{{ f.from.code }}</div>
                  <div class="text-xs font-bold text-slate-400">{{ timeOnly(f.departure) }}</div>
                </div>
                <div class="flex flex-col items-center px-4 w-full">
                  <div class="text-[10px] text-slate-400 font-bold mb-2">{{ f.flightNo }}</div>
                  <div class="w-full h-0.5 bg-gradient-to-r from-pink-300 via-pink-400 to-pink-300 relative rounded-full">
                    <div class="absolute -right-1 top-1/2 -translate-y-1/2 w-2 h-2 bg-pink-500 rounded-full shadow-lg shadow-pink-500/50"></div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-3xl font-black sakura-text">{{ f.to.code }}</div>
                  <div class="text-xs font-bold text-slate-400">{{ timeOnly(f.arrival) }}</div>
                </div>
              </div>
            </div>
          </section>

          <!-- Stays Card -->
          <section>
            <h3 class="text-xs font-bold text-pink-400 uppercase tracking-widest mb-3 pl-1 flex items-center gap-2">
              <span class="w-4 h-px bg-pink-300"></span>
              Accommodation ğŸ¨
            </h3>
            <div class="space-y-3">
              <div v-for="s in config.stays" :key="s.id" class="glass-card rounded-2xl p-4 flex gap-4 items-center group hover:shadow-lg hover:shadow-pink-200/50 transition-all duration-300 cursor-pointer">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-pink-100 to-pink-200 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                  ğŸ¨
                </div>
                <div class="flex-1">
                  <h4 class="font-bold text-slate-700 text-sm">{{ s.name }}</h4>
                  <div class="text-xs text-slate-400 mt-0.5">{{ s.area }} Â· {{ shortDate(s.checkIn) }}-{{ shortDate(s.checkOut) }}</div>
                </div>
                <div class="text-pink-300 group-hover:text-pink-500 transition-colors">â†’</div>
              </div>
            </div>
          </section>
        </div>

        <!-- Day Detail -->
        <div v-else-if="activeKind === 'day'" class="space-y-6">
          <div v-if="currentDay">
            <!-- Day Header -->
            <div class="glass-card sakura-border rounded-3xl p-6 text-center relative overflow-hidden sakura-glow">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-pink-300 via-pink-500 to-pink-300"></div>
              <div class="absolute top-3 right-3 text-2xl opacity-30">ğŸŒ¸</div>
              
              <div class="relative z-10">
                <div class="text-xs font-bold text-pink-500 mb-2">{{ currentDay.date }} Â· {{ currentDay.label }}</div>
                <h2 class="text-2xl font-black mb-3 leading-tight sakura-text">{{ currentDay.title }}</h2>
                <div v-if="currentDay.weather" class="inline-flex items-center gap-1.5 bg-sky-50 text-sky-600 px-3 py-1.5 rounded-full text-xs font-bold mb-4 border border-sky-100">
                  <span>{{ currentDay.weather }}</span>
                </div>
                
                <div v-if="currentDay.stayId" class="flex items-center justify-center gap-2 text-xs text-slate-500 bg-pink-50 rounded-xl p-3 mt-2 border border-pink-100">
                  <span>ğŸ </span>
                  <span class="font-bold">{{ stayName(currentDay.stayId) }}</span>
                </div>
              </div>
            </div>

            <!-- Blocks -->
            <div class="space-y-4">
              <div v-for="(block, idx) in currentDay.blocks" :key="idx" class="relative pl-8">
                <div class="absolute left-[11px] top-8 bottom-0 w-0.5 timeline-line -z-10" v-if="idx !== currentDay.blocks.length - 1"></div>
                
                <div class="absolute left-0 top-1 w-6 h-6 rounded-full timeline-dot flex items-center justify-center text-xs z-10 text-white">
                  {{ getBlockIcon(block.type) }}
                </div>

                <div :class="['glass-card rounded-2xl p-4 ml-2 transition-all hover:shadow-lg hover:shadow-pink-100', block.type === 'dinnerRecommend' ? 'border-l-2 border-l-orange-300' : '']">
                  
                  <div class="flex justify-between items-start mb-3">
                    <h3 class="font-bold text-slate-700 text-sm">{{ block.title }}</h3>
                    <span v-if="block.timeOfDay" class="text-[10px] font-bold bg-pink-50 text-pink-500 px-2 py-0.5 rounded-full">{{ block.timeOfDay }}</span>
                  </div>

                  <div v-if="block.type === 'transport'" class="space-y-3">
                    <div class="flex items-center gap-2 text-xs font-bold text-slate-500">
                      <span>{{ block.from }}</span>
                      <span class="text-pink-400">â†’</span>
                      <span>{{ block.to }}</span>
                    </div>
                    <div v-for="route in block.routes" class="bg-pink-50/50 rounded-xl p-3 border border-pink-100">
                      <div class="font-bold text-slate-600 text-sm mb-1">{{ route.label }}</div>
                      <div class="text-[10px] text-slate-400 mb-2 flex gap-3">
                        <span v-if="route.estimatedDurationMinutes" class="flex items-center gap-1">â± {{ route.estimatedDurationMinutes }}åˆ†</span>
                        <span v-if="route.estimatedCost" class="flex items-center gap-1">ğŸ’° {{ route.estimatedCost }}</span>
                      </div>
                      <div v-if="route.via" class="space-y-1.5">
                        <div v-for="step in route.via" class="text-xs text-slate-500 flex items-start gap-2">
                          <span class="text-pink-400 mt-0.5">ğŸŒ¸</span>
                          <span class="leading-relaxed">{{ step }}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div v-else-if="block.type === 'dinnerRecommend'" class="space-y-3">
                    <div v-for="opt in block.options" class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-3 border border-orange-100">
                      <div class="flex justify-between items-start">
                        <div class="font-bold text-slate-700 text-sm">{{ opt.name }}</div>
                        <div class="text-xs font-bold text-orange-500 bg-orange-100 px-2 py-0.5 rounded-lg">{{ opt.rating }}</div>
                      </div>
                      <div class="flex flex-wrap gap-1.5 my-2">
                        <span v-for="tag in opt.tags" class="text-[10px] bg-white text-slate-500 px-2 py-0.5 rounded-full border border-orange-100">{{ tag }}</span>
                      </div>
                      <div class="text-xs text-slate-500 leading-relaxed">{{ opt.desc }}</div>
                      <a v-if="opt.url" :href="opt.url" target="_blank" class="mt-3 block text-center bg-orange-100 text-orange-600 text-xs font-bold py-2 rounded-lg hover:bg-orange-200 transition-colors">ğŸ“ Google Maps</a>
                    </div>
                  </div>

                  <ul v-else-if="block.items" class="space-y-2">
                    <li v-for="item in block.items" class="text-sm text-slate-600 flex items-start gap-2">
                      <span class="text-pink-400 font-bold mt-0.5">âœ“</span>
                      <span class="leading-relaxed">{{ item }}</span>
                    </li>
                  </ul>

                  <div v-else-if="block.lines" class="text-sm text-slate-500 space-y-1">
                    <p v-for="line in block.lines">{{ line }}</p>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Map -->
        <div v-else-if="activeKind === 'map'" class="space-y-4">
          <div class="glass-card sakura-border rounded-2xl p-4">
            <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
              <span class="text-pink-500">ğŸ—ºï¸</span> æ™¯é»åœ°åœ–
            </h3>
            <div id="map-container" class="rounded-xl overflow-hidden"></div>
            <div class="mt-3 text-xs text-slate-400 text-center">é»æ“Šæ¨™è¨˜æŸ¥çœ‹è©³æƒ…</div>
          </div>
          
          <div class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-slate-700 mb-3">åœ–ä¾‹</h3>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div class="flex items-center gap-2 text-slate-500"><span class="w-3 h-3 rounded-full bg-pink-400"></span> æ™¯é»</div>
              <div class="flex items-center gap-2 text-slate-500"><span class="w-3 h-3 rounded-full bg-blue-400"></span> ä½å®¿</div>
              <div class="flex items-center gap-2 text-slate-500"><span class="w-3 h-3 rounded-full bg-orange-400"></span> é¤å»³</div>
              <div class="flex items-center gap-2 text-slate-500"><span class="w-3 h-3 rounded-full bg-green-400"></span> è³¼ç‰©</div>
            </div>
          </div>
        </div>

        <!-- Packing List -->
        <div v-else-if="activeKind === 'packing'" class="space-y-4">
          <div class="glass-card sakura-border rounded-2xl p-4 text-center sakura-glow">
            <div class="text-3xl font-black sakura-text">{{ packingProgress }}%</div>
            <div class="text-xs text-slate-400 mt-1">æ‰“åŒ…é€²åº¦</div>
            <div class="w-full h-3 bg-pink-100 rounded-full mt-3 overflow-hidden">
              <div class="h-full bg-gradient-to-r from-pink-400 to-pink-500 transition-all duration-500 rounded-full" :style="{width: packingProgress + '%'}"></div>
            </div>
          </div>
          
          <div v-for="cat in packingCategories" :key="cat.name" class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
              <span>{{ cat.icon }}</span> {{ cat.name }}
            </h3>
            <div class="space-y-2">
              <div v-for="item in cat.items" :key="item" 
                   @click="togglePackingItem(cat.name, item)"
                   class="checklist-item flex items-center gap-3 p-2 rounded-lg hover:bg-pink-50 cursor-pointer transition-all"
                   :class="{ 'checked': isPackedItem(cat.name, item) }">
                <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all"
                     :class="isPackedItem(cat.name, item) ? 'bg-pink-500 border-pink-500 text-white' : 'border-pink-300'">
                  <span v-if="isPackedItem(cat.name, item)" class="text-xs">âœ“</span>
                </div>
                <span class="text-sm text-slate-600">{{ item }}</span>
              </div>
            </div>
          </div>
          
          <button @click="resetPacking" class="w-full py-3 text-xs font-bold text-slate-400 hover:text-red-400 transition-colors">
            ğŸ”„ é‡ç½®æ‰“åŒ…æ¸…å–®
          </button>
        </div>

        <!-- Currency Converter -->
        <div v-else-if="activeKind === 'currency'" class="space-y-4">
          <div class="glass-card sakura-border rounded-2xl p-6 sakura-glow">
            <div class="text-center mb-6">
              <div class="text-xs text-pink-500 font-bold mb-1">å³æ™‚åŒ¯ç‡</div>
              <div class="text-2xl font-black sakura-text">1 TWD = {{ exchangeRate }} JPY</div>
              <div class="text-xs text-slate-400 mt-1">æ›´æ–°æ™‚é–“ï¼š{{ rateUpdateTime }}</div>
            </div>
            
            <div class="space-y-4">
              <div class="bg-white/50 rounded-xl p-4 border border-pink-100">
                <label class="text-xs text-slate-500 block mb-2">ğŸ‡¹ğŸ‡¼ å°å¹£ TWD</label>
                <input type="number" v-model="twdAmount" @input="convertToJpy"
                       class="w-full bg-transparent text-2xl font-bold text-slate-700 outline-none"
                       placeholder="0">
              </div>
              
              <div class="text-center text-pink-300 text-xl">â†•ï¸</div>
              
              <div class="bg-white/50 rounded-xl p-4 border border-pink-100">
                <label class="text-xs text-slate-500 block mb-2">ğŸ‡¯ğŸ‡µ æ—¥åœ“ JPY</label>
                <input type="number" v-model="jpyAmount" @input="convertToTwd"
                       class="w-full bg-transparent text-2xl font-bold text-slate-700 outline-none"
                       placeholder="0">
              </div>
            </div>
          </div>
          
          <div class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-slate-700 mb-3">ğŸ’¡ å¿«é€Ÿæ›ç®—</h3>
            <div class="grid grid-cols-2 gap-2">
              <div v-for="amt in [1000, 5000, 10000, 50000]" :key="amt" 
                   @click="twdAmount = amt; convertToJpy()"
                   class="bg-pink-50 p-3 rounded-xl text-center cursor-pointer hover:bg-pink-100 transition-colors border border-pink-100">
                <div class="text-xs text-slate-500">{{ amt.toLocaleString() }} TWD</div>
                <div class="text-sm font-bold sakura-text">â‰ˆ {{ Math.round(amt * exchangeRate).toLocaleString() }} JPY</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Phrasebook -->
        <div v-else-if="activeKind === 'phrase'" class="grid grid-cols-1 gap-3">
          <div v-for="p in config.phrasebook" @click="speak(p.jp)" class="glass-card p-4 rounded-2xl active:scale-[0.98] transition-all cursor-pointer hover:shadow-lg hover:shadow-pink-100 group">
            <div class="text-xs font-bold text-pink-500 mb-1">{{ p.label }}</div>
            <div class="text-lg font-bold text-slate-700">{{ p.jp }}</div>
            <div class="flex justify-between items-center mt-2">
              <div class="text-[10px] text-slate-400">{{ p.note }}</div>
              <div class="text-[10px] bg-pink-50 text-pink-500 px-2.5 py-1 rounded-full group-hover:bg-pink-500 group-hover:text-white transition-colors">ğŸ”Š æ’­æ”¾</div>
            </div>
          </div>
        </div>

        <!-- Photos -->
        <div v-else-if="activeKind === 'photos'" class="space-y-4">
          <div class="glass-card sakura-border rounded-2xl p-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-sm font-bold text-slate-700">ğŸ“¸ æ—…é€”å›æ†¶</h3>
              <label class="bg-pink-100 hover:bg-pink-200 px-3 py-1.5 rounded-lg text-xs font-bold text-pink-600 cursor-pointer transition-colors">
                + æ–°å¢ç…§ç‰‡
                <input type="file" accept="image/*" multiple @change="addPhotos" class="hidden">
              </label>
            </div>
            
            <div v-if="photos.length === 0" class="text-center py-8 text-slate-400">
              <div class="text-4xl mb-2">ğŸ“·</div>
              <div class="text-sm">é‚„æ²’æœ‰ç…§ç‰‡</div>
              <div class="text-xs">é–‹å§‹æ—…ç¨‹å¾Œè¨˜éŒ„ç¾å¥½å›æ†¶å§ï¼</div>
            </div>
            
            <div v-else class="photo-grid">
              <div v-for="(photo, idx) in photos" :key="idx" class="relative group">
                <img :src="photo.data" class="photo-item w-full cursor-pointer border-2 border-white shadow-md" @click="viewPhoto(idx)">
                <button @click.stop="removePhoto(idx)" class="absolute top-1 right-1 w-6 h-6 bg-red-500 rounded-full text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity shadow-lg">Ã—</button>
              </div>
            </div>
          </div>
          
          <div v-if="photos.length > 0" class="text-center text-xs text-slate-400">
            å…± {{ photos.length }} å¼µç…§ç‰‡ ğŸŒ¸
          </div>
        </div>

        <!-- Weather -->
        <div v-else-if="activeKind === 'weather'" class="space-y-4">
          <div class="glass-card sakura-border rounded-2xl p-6 text-center sakura-glow">
            <div class="text-6xl mb-2">{{ weatherData.icon }}</div>
            <div class="text-4xl font-black sakura-text">{{ weatherData.temp }}Â°C</div>
            <div class="text-slate-500 mt-1">{{ weatherData.description }}</div>
            <div class="text-xs text-slate-400 mt-2">æ±äº¬ Â· {{ weatherData.updateTime }}</div>
          </div>
          
          <div class="grid grid-cols-3 gap-3">
            <div class="glass-card rounded-xl p-3 text-center">
              <div class="text-xl mb-1">ğŸ’§</div>
              <div class="text-lg font-bold text-slate-700">{{ weatherData.humidity }}%</div>
              <div class="text-xs text-slate-400">æ¿•åº¦</div>
            </div>
            <div class="glass-card rounded-xl p-3 text-center">
              <div class="text-xl mb-1">ğŸ’¨</div>
              <div class="text-lg font-bold text-slate-700">{{ weatherData.wind }} m/s</div>
              <div class="text-xs text-slate-400">é¢¨é€Ÿ</div>
            </div>
            <div class="glass-card rounded-xl p-3 text-center">
              <div class="text-xl mb-1">ğŸŒ¡ï¸</div>
              <div class="text-lg font-bold text-slate-700">{{ weatherData.feelsLike }}Â°C</div>
              <div class="text-xs text-slate-400">é«”æ„Ÿ</div>
            </div>
          </div>
          
          <div class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-slate-700 mb-3">æœªä¾† 5 å¤©</h3>
            <div class="space-y-2">
              <div v-for="day in weatherForecast" :key="day.date" class="flex justify-between items-center p-2 rounded-lg hover:bg-pink-50">
                <div class="text-sm text-slate-600">{{ day.date }}</div>
                <div class="text-xl">{{ day.icon }}</div>
                <div class="text-sm font-bold text-slate-700">{{ day.high }}Â° / {{ day.low }}Â°</div>
              </div>
            </div>
          </div>
          
          <button @click="refreshWeather" class="w-full glass-card py-3 rounded-xl text-sm font-bold text-pink-500 hover:bg-pink-50 transition-colors">
            ğŸ”„ æ›´æ–°å¤©æ°£
          </button>
        </div>

        <!-- Emergency -->
        <div v-else-if="activeKind === 'emergency'" class="space-y-4">
          <div class="glass-card rounded-2xl p-4 border-l-4 border-l-red-400">
            <h3 class="text-sm font-bold text-red-500 mb-3">ğŸ†˜ ç·Šæ€¥è¯çµ¡</h3>
            <div class="space-y-3">
              <a href="tel:110" class="flex items-center gap-3 p-3 bg-red-50 rounded-xl border border-red-100">
                <span class="text-2xl">ğŸ‘®</span>
                <div>
                  <div class="font-bold text-slate-700">è­¦å¯Ÿ</div>
                  <div class="text-xs text-slate-500">110</div>
                </div>
              </a>
              <a href="tel:119" class="flex items-center gap-3 p-3 bg-orange-50 rounded-xl border border-orange-100">
                <span class="text-2xl">ğŸš‘</span>
                <div>
                  <div class="font-bold text-slate-700">æ•‘è­·è»Š / æ¶ˆé˜²</div>
                  <div class="text-xs text-slate-500">119</div>
                </div>
              </a>
            </div>
          </div>
          
          <div class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-slate-700 mb-3">ğŸ›ï¸ å°ç£é§æ—¥ä»£è¡¨è™•</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-slate-400">åœ°å€</span>
                <span class="text-slate-700 text-right">æ±äº¬éƒ½æ¸¯åŒºç™½é‡‘å°5-20-2</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-400">é›»è©±</span>
                <a href="tel:+81-3-3280-7811" class="text-pink-500">03-3280-7811</a>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-400">æ€¥é›£æ•‘åŠ©</span>
                <a href="tel:+81-80-6552-4764" class="text-pink-500">080-6552-4764</a>
              </div>
            </div>
          </div>
          
          <div class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-slate-700 mb-3">ğŸ¨ ä½å®¿è³‡è¨Š</h3>
            <div v-for="s in config.stays" :key="s.id" class="p-3 bg-pink-50 rounded-xl mb-2 border border-pink-100">
              <div class="font-bold text-slate-700 text-sm">{{ s.name }}</div>
              <div class="text-xs text-slate-500 mt-1">{{ s.area }}</div>
              <div class="text-xs text-slate-500">{{ shortDate(s.checkIn) }} - {{ shortDate(s.checkOut) }}</div>
            </div>
          </div>
          
          <div class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-slate-700 mb-3">ğŸ’Š å¸¸ç”¨æ—¥èªï¼ˆç·Šæ€¥ï¼‰</h3>
            <div class="space-y-2">
              <div @click="speak('åŠ©ã‘ã¦ãã ã•ã„')" class="p-2 bg-pink-50 rounded-lg cursor-pointer hover:bg-pink-100 border border-pink-100">
                <div class="text-sm text-slate-700">åŠ©ã‘ã¦ãã ã•ã„</div>
                <div class="text-xs text-slate-400">è«‹å¹«å¹«æˆ‘</div>
              </div>
              <div @click="speak('ç—…é™¢ã¯ã©ã“ã§ã™ã‹')" class="p-2 bg-pink-50 rounded-lg cursor-pointer hover:bg-pink-100 border border-pink-100">
                <div class="text-sm text-slate-700">ç—…é™¢ã¯ã©ã“ã§ã™ã‹</div>
                <div class="text-xs text-slate-400">é†«é™¢åœ¨å“ªè£¡ï¼Ÿ</div>
              </div>
              <div @click="speak('è­¦å¯Ÿã‚’å‘¼ã‚“ã§ãã ã•ã„')" class="p-2 bg-pink-50 rounded-lg cursor-pointer hover:bg-pink-100 border border-pink-100">
                <div class="text-sm text-slate-700">è­¦å¯Ÿã‚’å‘¼ã‚“ã§ãã ã•ã„</div>
                <div class="text-xs text-slate-400">è«‹å«è­¦å¯Ÿ</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Share -->
        <div v-else-if="activeKind === 'share'" class="space-y-4">
          <div class="glass-card sakura-border rounded-2xl p-6 text-center sakura-glow">
            <h3 class="text-sm font-bold text-slate-700 mb-4">ğŸ”— åˆ†äº«è¡Œç¨‹</h3>
            <div id="qrcode" class="inline-block p-4 bg-white rounded-2xl mb-4 shadow-lg"></div>
            <div class="text-xs text-slate-400 mb-4">æƒæ QR Code æŸ¥çœ‹è¡Œç¨‹</div>
            <button @click="copyLink" class="w-full bg-pink-100 hover:bg-pink-200 py-3 rounded-xl text-sm font-bold text-pink-600 transition-colors">
              ğŸ“‹ è¤‡è£½é€£çµ
            </button>
          </div>
          
          <div class="glass-card rounded-2xl p-4">
            <h3 class="text-sm font-bold text-slate-700 mb-3">ğŸ“± åˆ†äº«åˆ°</h3>
            <div class="grid grid-cols-3 gap-3">
              <a :href="'https://line.me/R/msg/text/?' + encodeURIComponent('2026æ±äº¬æ—…è¡ŒğŸŒ¸ ' + shareUrl)" target="_blank" class="bg-[#06C755] p-4 rounded-xl text-center hover:opacity-90 transition-opacity">
                <div class="text-2xl mb-1">ğŸ’¬</div>
                <div class="text-xs text-white font-bold">LINE</div>
              </a>
              <a :href="'mailto:?subject=2026æ±äº¬æ—…è¡ŒğŸŒ¸&body=' + encodeURIComponent(shareUrl)" class="bg-blue-500 p-4 rounded-xl text-center hover:opacity-90 transition-opacity">
                <div class="text-2xl mb-1">ğŸ“§</div>
                <div class="text-xs text-white font-bold">Email</div>
              </a>
              <button @click="nativeShare" class="bg-pink-500 p-4 rounded-xl text-center hover:opacity-90 transition-opacity">
                <div class="text-2xl mb-1">ğŸ“¤</div>
                <div class="text-xs text-white font-bold">å…¶ä»–</div>
              </button>
            </div>
          </div>
        </div>

        <!-- Budget -->
        <div v-else-if="activeKind === 'budget'" class="space-y-4">
          <div class="glass-card sakura-border rounded-2xl p-6 text-center sakura-glow">
            <div class="text-xs font-bold text-pink-500 mb-2 tracking-wider">Total Expenses</div>
            <div class="text-5xl font-black sakura-text">{{ totalBudget() }}</div>
            <div class="text-sm font-bold text-slate-400 mt-1">{{ config.budget.currency }}</div>
          </div>
          
          <div class="space-y-2">
            <div v-for="d in config.days" class="glass-card p-4 rounded-xl flex justify-between items-center hover:shadow-lg hover:shadow-pink-100 transition-all">
              <div>
                <div class="font-bold text-slate-700 text-sm">{{ d.label }}</div>
                <div class="text-xs text-slate-400">{{ shortDate(d.date) }}</div>
              </div>
              <div class="font-mono font-bold text-lg sakura-text">{{ dayTotal(d.date) }}</div>
            </div>
          </div>
          
          <button @click="clearAllBudget" class="w-full py-4 text-xs font-bold text-slate-400 hover:text-red-400 transition-colors">âš ï¸ æ¸…é™¤æ‰€æœ‰è¨˜éŒ„</button>
        </div>

      </main>
    </div>
    
    <!-- Photo Viewer Modal -->
    <div v-if="viewingPhoto !== null" @click="viewingPhoto = null" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
      <img :src="photos[viewingPhoto]?.data" class="max-w-full max-h-full object-contain rounded-lg">
      <button @click="viewingPhoto = null" class="absolute top-4 right-4 w-10 h-10 bg-white/20 rounded-full text-xl text-white">Ã—</button>
    </div>
  </div>

  <script>
    // Create falling petals
    function createPetals() {
      const container = document.getElementById('petals');
      const petalCount = 15;
      
      for (let i = 0; i < petalCount; i++) {
        const petal = document.createElement('div');
        petal.className = 'petal';
        petal.innerHTML = 'ğŸŒ¸';
        petal.style.left = Math.random() * 100 + '%';
        petal.style.fontSize = (Math.random() * 15 + 10) + 'px';
        petal.style.opacity = Math.random() * 0.5 + 0.3;
        petal.style.animationDuration = (Math.random() * 10 + 10) + 's';
        petal.style.animationDelay = (Math.random() * 10) + 's';
        container.appendChild(petal);
      }
    }
    createPetals();

    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
    const BUDGET_KEY = "trip-budget-v2";
    const PACKING_KEY = "trip-packing-v1";
    const PHOTOS_KEY = "trip-photos-v1";

    createApp({
      setup() {
        const config = ref(null);
        const loading = ref(true);
        const activeKind = ref('overview');
        const activeDayDate = ref('');
        const budgetData = ref({});
        const packedItems = ref({});
        const photos = ref([]);
        const viewingPhoto = ref(null);
        
        const twdAmount = ref('');
        const jpyAmount = ref('');
        const exchangeRate = ref(4.6);
        const rateUpdateTime = ref('--');
        
        const weatherData = ref({
          icon: 'â˜€ï¸', temp: '--', description: 'è¼‰å…¥ä¸­...',
          humidity: '--', wind: '--', feelsLike: '--', updateTime: '--'
        });
        const weatherForecast = ref([]);
        
        let map = null;
        const shareUrl = window.location.href;

        const packingCategories = ref([
          { name: 'è­‰ä»¶æ–‡ä»¶', icon: 'ğŸ“„', items: ['è­·ç…§', 'èº«åˆ†è­‰', 'æ©Ÿç¥¨', 'é£¯åº—è¨‚æˆ¿ç¢ºèª', 'æ—…å¹³éšªä¿å–®', 'æ—¥å¹£ç¾é‡‘', 'ä¿¡ç”¨å¡'] },
          { name: 'é›»å­ç”¢å“', icon: 'ğŸ”Œ', items: ['æ‰‹æ©Ÿ', 'å……é›»å™¨', 'è¡Œå‹•é›»æº', 'ç›¸æ©Ÿ', 'è¨˜æ†¶å¡', 'è½‰æ¥é ­', 'è€³æ©Ÿ'] },
          { name: 'è¡£ç‰©', icon: 'ğŸ‘•', items: ['ä¸Šè¡£ x3', 'è¤²å­ x2', 'å…§è¡£è¤² x4', 'å¤–å¥—', 'ç¡è¡£', 'è¥ªå­ x4', 'èˆ’é©èµ°è·¯é‹'] },
          { name: 'ç›¥æ´—ç”¨å“', icon: 'ğŸ§´', items: ['ç‰™åˆ·ç‰™è†', 'æ´—é¢ä¹³', 'ä¿é¤Šå“', 'é˜²æ›¬ä¹³', 'æ¢³å­', 'æ¯›å·¾'] },
          { name: 'å…¶ä»–', icon: 'ğŸ’', items: ['é›¨å‚˜/é›¨è¡£', 'è—¥å“', 'é›¶é£Ÿ', 'æ°´å£º', 'è³¼ç‰©è¢‹', 'æ—…éŠæ›¸'] }
        ]);

        const getBlockIcon = (type) => {
          const map = { 'transport': 'ğŸš†', 'packingToday': 'ğŸ’', 'todo': 'âœ…', 'mealOptions': 'ğŸ”', 'dinnerRecommend': 'ğŸ½ï¸', 'note': 'ğŸ“' };
          return map[type] || 'ğŸ“';
        };

        const shortDate = (s) => s ? s.split('-').slice(1).join('/') : '';
        const dateOnly = (s) => s ? s.split('T')[0] : '';
        const timeOnly = (s) => s ? s.split('T')[1]?.substring(0,5) : '';
        const stayName = (id) => config.value?.stays.find(s => s.id === id)?.name;

        const countdownDays = computed(() => {
          if (!config.value) return '--';
          const start = new Date(config.value.tripMeta.startDate);
          const now = new Date();
          const diff = Math.ceil((start - now) / (1000 * 60 * 60 * 24));
          if (diff < 0) return Math.abs(diff);
          return diff;
        });
        
        const countdownLabel = computed(() => {
          if (!config.value) return '';
          const start = new Date(config.value.tripMeta.startDate);
          const end = new Date(config.value.tripMeta.endDate);
          const now = new Date();
          if (now < start) return 'è·é›¢å‡ºç™¼é‚„æœ‰';
          if (now >= start && now <= end) return 'æ—…ç¨‹é€²è¡Œä¸­ï¼ç¬¬';
          return 'æ—…ç¨‹çµæŸ';
        });
        
        const countdownSubtext = computed(() => {
          if (!config.value) return '';
          const start = new Date(config.value.tripMeta.startDate);
          const end = new Date(config.value.tripMeta.endDate);
          const now = new Date();
          if (now < start) return 'å¤©';
          if (now >= start && now <= end) return 'å¤©';
          return 'å¤©å‰çµæŸ';
        });

        const currentDay = computed(() => config.value?.days.find(d => d.date === activeDayDate.value));

        const selectDay = (date) => { activeKind.value = 'day'; activeDayDate.value = date; };
        const speak = (text) => { const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; window.speechSynthesis.speak(u); };

        const loadBudget = () => { try { const raw = localStorage.getItem(BUDGET_KEY); if(raw) budgetData.value = JSON.parse(raw); } catch(e) {} };
        const saveBudget = () => localStorage.setItem(BUDGET_KEY, JSON.stringify(budgetData.value));
        const dayTotal = (date) => (budgetData.value[date] || []).reduce((a,b) => a + Number(b.amount), 0);
        const totalBudget = () => Object.values(budgetData.value).flat().reduce((a,b) => a + Number(b.amount), 0);
        const clearAllBudget = () => { if(confirm('æ¸…é™¤æ‰€æœ‰è¨˜å¸³è³‡æ–™ï¼Ÿ')) { budgetData.value = {}; saveBudget(); } };

        const loadPacking = () => { try { const raw = localStorage.getItem(PACKING_KEY); if(raw) packedItems.value = JSON.parse(raw); } catch(e) {} };
        const savePacking = () => localStorage.setItem(PACKING_KEY, JSON.stringify(packedItems.value));
        const togglePackingItem = (cat, item) => { const key = `${cat}:${item}`; if(packedItems.value[key]) delete packedItems.value[key]; else packedItems.value[key] = true; savePacking(); };
        const isPackedItem = (cat, item) => !!packedItems.value[`${cat}:${item}`];
        const packingProgress = computed(() => { const total = packingCategories.value.reduce((sum, cat) => sum + cat.items.length, 0); return Math.round((Object.keys(packedItems.value).length / total) * 100); });
        const resetPacking = () => { if(confirm('é‡ç½®æ‰€æœ‰æ‰“åŒ…é€²åº¦ï¼Ÿ')) { packedItems.value = {}; savePacking(); } };

        const convertToJpy = () => { if(twdAmount.value) jpyAmount.value = Math.round(twdAmount.value * exchangeRate.value); else jpyAmount.value = ''; };
        const convertToTwd = () => { if(jpyAmount.value) twdAmount.value = Math.round(jpyAmount.value / exchangeRate.value); else twdAmount.value = ''; };
        const fetchExchangeRate = async () => { try { const res = await fetch('https://api.exchangerate-api.com/v4/latest/TWD'); const data = await res.json(); exchangeRate.value = data.rates.JPY.toFixed(2); rateUpdateTime.value = new Date().toLocaleTimeString('zh-TW'); } catch(e) { rateUpdateTime.value = 'ä½¿ç”¨é è¨­åŒ¯ç‡'; } };

        const refreshWeather = async () => {
          try {
            const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.6762&longitude=139.6503&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo');
            const data = await res.json();
            const weatherIcons = { 0: 'â˜€ï¸', 1: 'ğŸŒ¤ï¸', 2: 'â›…', 3: 'â˜ï¸', 45: 'ğŸŒ«ï¸', 48: 'ğŸŒ«ï¸', 51: 'ğŸŒ§ï¸', 53: 'ğŸŒ§ï¸', 55: 'ğŸŒ§ï¸', 61: 'ğŸŒ§ï¸', 63: 'ğŸŒ§ï¸', 65: 'ğŸŒ§ï¸', 71: 'â„ï¸', 73: 'â„ï¸', 75: 'â„ï¸', 80: 'ğŸŒ§ï¸', 81: 'ğŸŒ§ï¸', 82: 'ğŸŒ§ï¸', 95: 'â›ˆï¸', 96: 'â›ˆï¸', 99: 'â›ˆï¸' };
            const weatherDesc = { 0: 'æ™´æœ—', 1: 'å¤§è‡´æ™´æœ—', 2: 'å±€éƒ¨å¤šé›²', 3: 'å¤šé›²', 45: 'æœ‰éœ§', 48: 'æœ‰éœ§', 51: 'å°é›¨', 53: 'ä¸­é›¨', 55: 'å¤§é›¨', 61: 'å°é›¨', 63: 'ä¸­é›¨', 65: 'å¤§é›¨', 71: 'å°é›ª', 73: 'ä¸­é›ª', 75: 'å¤§é›ª', 80: 'é™£é›¨', 81: 'é™£é›¨', 82: 'å¤§é™£é›¨', 95: 'é›·é›¨', 96: 'é›·é›¨', 99: 'é›·é›¨' };
            const code = data.current.weather_code;
            weatherData.value = { icon: weatherIcons[code] || 'ğŸŒ¤ï¸', temp: Math.round(data.current.temperature_2m), description: weatherDesc[code] || 'æœªçŸ¥', humidity: data.current.relative_humidity_2m, wind: data.current.wind_speed_10m, feelsLike: Math.round(data.current.apparent_temperature), updateTime: new Date().toLocaleTimeString('zh-TW') };
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weatherForecast.value = data.daily.time.slice(1, 6).map((date, i) => { const d = new Date(date); return { date: `${d.getMonth()+1}/${d.getDate()} (${days[d.getDay()]})`, icon: weatherIcons[data.daily.weather_code[i+1]] || 'ğŸŒ¤ï¸', high: Math.round(data.daily.temperature_2m_max[i+1]), low: Math.round(data.daily.temperature_2m_min[i+1]) }; });
          } catch(e) { console.error('Weather fetch error:', e); }
        };

        const loadPhotos = () => { try { const raw = localStorage.getItem(PHOTOS_KEY); if(raw) photos.value = JSON.parse(raw); } catch(e) {} };
        const savePhotos = () => { try { localStorage.setItem(PHOTOS_KEY, JSON.stringify(photos.value)); } catch(e) { alert('ç…§ç‰‡å¤ªå¤šï¼Œå„²å­˜ç©ºé–“ä¸è¶³ï¼'); } };
        const addPhotos = (e) => {
          const files = e.target.files;
          for(let file of files) {
            const reader = new FileReader();
            reader.onload = (ev) => {
              const img = new Image();
              img.onload = () => {
                const canvas = document.createElement('canvas');
                const maxSize = 800;
                let w = img.width, h = img.height;
                if(w > h && w > maxSize) { h = h * maxSize / w; w = maxSize; }
                else if(h > maxSize) { w = w * maxSize / h; h = maxSize; }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                photos.value.push({ data: canvas.toDataURL('image/jpeg', 0.7), date: new Date().toISOString() });
                savePhotos();
              };
              img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
          }
        };
        const removePhoto = (idx) => { if(confirm('åˆªé™¤é€™å¼µç…§ç‰‡ï¼Ÿ')) { photos.value.splice(idx, 1); savePhotos(); } };
        const viewPhoto = (idx) => { viewingPhoto.value = idx; };

        const initMap = () => {
          if(map) return;
          nextTick(() => {
            const container = document.getElementById('map-container');
            if(!container) return;
            map = L.map('map-container', { zoomControl: false }).setView([35.6762, 139.7503], 11);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'Â© CartoDB' }).addTo(map);
            const landmarks = [
              { name: 'æ±äº¬è»Šç«™', lat: 35.6812, lng: 139.7671 },
              { name: 'æ·ºè‰å¯º', lat: 35.7148, lng: 139.7967 },
              { name: 'æ±äº¬å¡”', lat: 35.6586, lng: 139.7454 },
              { name: 'æ–°å®¿', lat: 35.6896, lng: 139.7006 },
              { name: 'æ¾€è°·', lat: 35.6580, lng: 139.7016 }
            ];
            landmarks.forEach(l => { L.circleMarker([l.lat, l.lng], { radius: 8, fillColor: '#ec4899', color: '#fff', weight: 2, fillOpacity: 0.8 }).addTo(map).bindPopup(`<b>${l.name}</b>`); });
          });
        };

        const generateQR = () => {
          nextTick(() => {
            const container = document.getElementById('qrcode');
            if(!container || container.hasChildNodes()) return;
            const qr = qrcode(0, 'M');
            qr.addData(shareUrl);
            qr.make();
            container.innerHTML = qr.createImgTag(5, 0);
          });
        };
        
        const copyLink = async () => { try { await navigator.clipboard.writeText(shareUrl); alert('å·²è¤‡è£½é€£çµï¼'); } catch(e) { prompt('è¤‡è£½æ­¤é€£çµï¼š', shareUrl); } };
        const nativeShare = async () => { if(navigator.share) { try { await navigator.share({ title: '2026 æ±äº¬å®¶åº­æ—…è¡Œ ğŸŒ¸', url: shareUrl }); } catch(e) {} } else { copyLink(); } };

        watch(activeKind, (val) => {
          if(val === 'map') initMap();
          if(val === 'share') generateQR();
          if(val === 'weather' && weatherData.value.temp === '--') refreshWeather();
        });

        onMounted(async () => {
          try {
             const res = await fetch('./trip-config.json?t=' + Date.now());
             config.value = await res.json();
             if(config.value.days.length) activeDayDate.value = config.value.days[0].date;
             loadBudget(); loadPacking(); loadPhotos(); fetchExchangeRate();
          } catch(e) { console.error(e); } 
          finally { loading.value = false; }
          if('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').catch(e => console.log('SW:', e)); }
        });

        return {
           config, loading, activeKind, activeDayDate, currentDay,
           shortDate, dateOnly, timeOnly, stayName, getBlockIcon,
           selectDay, speak, countdownDays, countdownLabel, countdownSubtext,
           dayTotal, totalBudget, clearAllBudget,
           packingCategories, packingProgress, togglePackingItem, isPackedItem, resetPacking,
           twdAmount, jpyAmount, exchangeRate, rateUpdateTime, convertToJpy, convertToTwd,
           weatherData, weatherForecast, refreshWeather,
           photos, viewingPhoto, addPhotos, removePhoto, viewPhoto,
           shareUrl, copyLink, nativeShare
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
